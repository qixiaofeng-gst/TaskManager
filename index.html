<!DOCTYPE html>
<html lang="cn">
<head>
  <script>window.addEventListener('load', () => {
    const
      const_proxy_handler = new Proxy({
        get: (target, p, _) => target[p],
        set: () => {
          console.error('Constant could not be set')
          return false
        },
      }, {
        get: (target, p, _) => target[p],
        set: () => false,
      }),
      Colors = new Proxy({
        KEY: 'style.backgroundColor|color',
        text: '#555555',
        footer_bg: '#f4fce8',
        border_lighter: '#ededed',
        white: '#ffffff',
        green: '#00bb00',
        gray: '#dddddd',
        yellow: '#ddcc00',
        shadow_lighter: 'rgba(0, 0, 0, .2)',
        button_bg: 'rgba(0, 0, 0, .1)',
      }, const_proxy_handler),
      Displays = new Proxy({
        KEY: 'style.display',
        flex: 'flex',
        block: 'block',
        grid: 'grid',
        none: 'none',
      }, const_proxy_handler),
      Repeats = new Proxy({
        KEY: 'style.backgroundRepeat',
        no_repeat: 'no-repeat',
      }, const_proxy_handler),
      Justifies = new Proxy({
        KEY: 'style.justifyContent',
        space_between: 'space-between',
      }, const_proxy_handler),
      Aligns = new Proxy({
        KEY: 'style.alignItems',
        center: 'center',
      }, const_proxy_handler),
      Cursors = new Proxy({
        KEY: 'style.cursor',
        pointer: 'pointer',
      }, const_proxy_handler),
      FontWeights = new Proxy({
        KEY: 'style.fontWeight',
        bold: 'bold',
      }, const_proxy_handler),
      InputTypes = new Proxy({
        KEY: 'type',
        text: 'text',
        password: 'password',
      }, const_proxy_handler),
      KeyNames = new Proxy({
        KEY: 'key',
        enter: 'Enter',
      }, const_proxy_handler),
      task_state = new Proxy({
        in_progress: 'wip',
        completed: 'done',
        pending: 'hung',
      }, const_proxy_handler),
      body = new Proxy({
        append: view => {
          document.body.append(view)
          return body
        },
      }, const_proxy_handler)

    HTMLElement.prototype.batchSetAttributes = function (obj) {
      for (const k in obj) {
        this[k] = obj[k]
      }
    }

    HTMLElement.prototype.checkAttribute = function (strKey, anyValue) {
      return this[strKey] === anyValue
    }

    class View extends HTMLElement {
      addView(newChild) {
        super.appendChild(newChild)
        return this
      }

      cutView(oldChild) {
        super.removeChild(oldChild)
        return this
      }

      setGridColumn(strTemplate, strGap) {
        this.style.gridColumnGap = strGap
        this.style.gridTemplateColumns = strTemplate
        return this
      }

      setAnimation(strValue) {
        this.style.animation = strValue
        return this
      }

      setWidth(strValue) {
        this.style.width = strValue
        return this
      }

      setHeight(strValue) {
        this.style.height = strValue
        return this
      }

      setFontWeight(strValue) {
        this.style.fontWeight = strValue
        return this
      }

      setBGColor(value) {
        this.style.backgroundColor = value
        return this
      }

      setBGImage(strValue) {
        this.style.backgroundImage = `url(${strValue})`
        return this
      }

      setBGPosition(strValue) {
        this.style.backgroundPosition = strValue
        return this
      }

      setBGSize(strValue) {
        this.style.backgroundSize = strValue
        return this
      }

      setBGRepeat(strValue) {
        this.style.backgroundRepeat = strValue
        return this
      }

      setDisplay(value) {
        this.style.display = value
        return this
      }

      setColor(value) {
        this.style.color = value
        return this
      }

      setPadding(value) {
        this.style.padding = value
        return this
      }

      setMargin(strValue) {
        this.style.margin = strValue
        return this
      }

      setShadow(value) {
        this.style.boxShadow = value
        return this
      }

      setBorderTop(value) {
        this.style.borderTop = value
        return this
      }

      setBorderBottom(strValue) {
        this.style.borderBottom = strValue
        return this
      }

      setJustifyContent(value) {
        this.style.justifyContent = value
        return this
      }

      setAlignItems(value) {
        this.style.alignItems = value
        return this
      }

      setFontSize(value) {
        this.style.fontSize = `${value}rem`
        return this
      }

      setLineHeight(value) {
        this.style.lineHeight = `${value}rem`
        return this
      }

      setRadius(strValue) {
        this.style.borderRadius = strValue
        return this
      }

      setCursor(value) {
        this.style.cursor = value
        return this
      }

      setContent(strValue) {
        this.innerHTML = strValue
        return this
      }
    }

    class Text extends View {
      constructor() {
        super()
        this.setDisplay(Displays.block)
      }
    }

    class SectionTitle extends View {
      _text = new Text()
      _removeButton = new IconButton()

      constructor() {
        super()
        this
          .setDisplay(Displays.flex)
          .setJustifyContent(Justifies.space_between)
          .setColor(Colors.text)
          .setFontSize(1)
          .setLineHeight(1)
          .setPadding('0 0 .4rem 0')
          .setFontWeight(FontWeights.bold)
          .setBorderBottom(`2px solid ${Colors.border_lighter}`)
          .setMargin('2rem 0 0 0')
          .addView(this._text)
          .addView(this._removeButton
            .setBGImage('css/destroy.png')
            .setDisplay(Displays.none))
      }

      setText(strValue) {
        this._text.setContent(strValue)
        return this
      }

      enableRemove(isEnable = true) {
        if (isEnable) {
          this.onmouseenter = () => this._removeButton.setDisplay(Displays.block)
          this.onmouseleave = () => this._removeButton.setDisplay(Displays.none)
        } else {
          this.onmouseenter = undefined
          this.onmouseleave = undefined
        }
        return this
      }
    }

    class Section extends View {
      _tasks = []
      _placeholder = new Text()
      _title = new SectionTitle()
      _onDragStart = _ => undefined
      _onDragEnd = () => undefined
      _onDrop = _ => undefined
      _beforeAddTask = _ => undefined
      _treatFirst = _ => undefined
      _afterAddTask = () => undefined

      constructor() {
        super()
        this
          .setDisplay(Displays.block)
          .addView(this._title)
          .addView(this._placeholder
            .setContent('无'))

        this.ondragover = e => e.preventDefault() // enable drop with this call
        this.ondragstart = e => this._onDragStart(e.target)
        this.ondrop = e => this._onDrop(e.target)
        this.ondragend = _ => this._onDragEnd()
      }

      get taskCount() {
        return this._tasks.length
      }

      setTitle(strValue) {
        this._title.setText(strValue)
        return this
      }

      enableClear(isEnable = true) {
        this._title.enableRemove(isEnable)
        return this
      }

      onDragStart(action) {
        this._onDragStart = action
        return this
      }

      onDragEnd(action) {
        this._onDragEnd = action
        return this
      }

      onDrop(action) {
        this._onDrop = action
        return this
      }

      beforeAddTask(action) {
        this._beforeAddTask = action
        return this
      }

      afterAddTask(action) {
        this._afterAddTask = action
        return this
      }

      treatFirst(action) {
        this._treatFirst = action
        return this
      }

      addTask(task) {
        if (0 === this._tasks.length) {
          this.cutView(this._placeholder)
          this._treatFirst(task)
        }
        this._beforeAddTask(task)
        this._tasks.push(task)
        this.addView(task)
        this._afterAddTask()
        return this
      }

      cutTask(task) {
        const index = this._tasks.indexOf(task)
        if (index >= 0) {
          this._tasks.splice(index, 1)
          this.cutView(task)

          if (0 === index && this._tasks.length > 0) {
            this._treatFirst(this._tasks[0])
          }
        }

        if (this._tasks.length) {
          this.addView(this._placeholder)
        }
        return this
      }
    }

    class Counter extends View {
      _generateContent = count => `count: ${count}`

      constructor() {
        super()
      }

      setContentGenerator(action) {
        this._generateContent = action
        return this
      }

      setCount(value) {
        return this.setContent(this._generateContent(value))
      }
    }

    class CounterButton extends Counter {
      constructor() {
        super()
        this
          .setDisplay(Displays.block)
          .setFontSize(.6)
          .setPadding('0 1rem')
          .setBGColor(Colors.button_bg)
          .setLineHeight(1.2)
          .setRadius('.6rem')
          .setShadow(`0 -1px 0 0 ${Colors.shadow_lighter}`)
          .setCursor(Cursors.pointer)

        this.onmouseenter = () => {
          this.setBGColor(Colors.shadow_lighter)
        }

        this.onmouseout = () => {
          this.setBGColor(Colors.button_bg)
        }
      }

      setCount(value) {
        if (value > 0) {
          this.setDisplay(Displays.block)
        } else {
          this.setDisplay(Displays.none)
        }
        return super.setCount(value)
      }
    }

    class Footer extends View {
      _wipCounter = new Counter()
      _buttonsContainer = new View()
      _completeCounter = new CounterButton()
      _pendingCounter = new CounterButton()

      constructor() {
        super()
        this
          .setDisplay(Displays.flex)
          .setJustifyContent(Justifies.space_between)
          .setAlignItems(Aligns.center)
          .setPadding('1rem')
          .setFontSize(.8)
          .setColor(Colors.text)
          .setBGColor(Colors.footer_bg)
          .setShadow(`0 2px 6px -1px ${Colors.shadow_lighter}`)
          .setBorderTop(`1px solid ${Colors.border_lighter}`)
          .addView(this._wipCounter
            .setContentGenerator(count => `${count} 项活动任务`)
            .setCount(0),
          )
          .addView(this._buttonsContainer
            .setDisplay(Displays.flex)
            .addView(this._completeCounter
              .setContentGenerator(count => `清除 ${count} 项已完成任务`)
              .setCount(0),
            )
            .addView(this._pendingCounter
              .setContentGenerator(count => `清除 ${count} 项已挂起任务`)
              .setCount(0),
            ),
          )
      }

      set wipCount(numValue) {
        this._wipCounter.setCount(numValue)
      }

      set pendingCount(numValue) {
        this._pendingCounter.setCount(numValue)
      }

      set completeCount(numValue) {
        this._completeCounter.setCount(numValue)
      }
    }

    class Input extends View {
      _onTextEntered = _ => undefined

      _view = document.createElement('input')
      _isFocused = false

      constructor() {
        super()
        this
          .setDisplay(Displays.block)
          .setMargin('1rem 0 0 0')
          .addView(this._view)
        this._view.style.fontSize = '1rem'
        this._view.style.padding = '.3rem'
        this._view.style.boxSizing = 'border-box'
        this._view.style.width = '100%'
        this._view.placeholder = '请输入任务'
        this._view.type = InputTypes.text

        this._view.onfocus = () => {
          this._isFocused = true
        }

        this._view.onblur = () => {
          this._isFocused = false
        }

        this._view.onkeypress = e => {
          const entered = this._view.value
          if (e.key === KeyNames.enter && entered) {
            this._view.value = ''
            if (this._view.checkAttribute(InputTypes.KEY, InputTypes.text)) {
              if (entered.startsWith(trait_login)) {
                credentials.email = entered.substr(trait_login.length, entered.length)
                this._view.batchSetAttributes({
                  placeholder: '输入密码',
                  type: InputTypes.password,
                })
              } else {
                this._onTextEntered(entered)
              }
            } else {
              this._view.batchSetAttributes({
                placeholder: '输入新任务',
                type: InputTypes.text,
              })
              login(credentials.email, entered)
                .then(() => {
                  location.reload()
                })
                .catch(
                  res => log(`登录失败 : ${res.msg}`),
                )
            }
          } else {
            log()
          }
        }
      }

      get isFocused() {
        return this._isFocused
      }

      focus(options) {
        this._view.focus(options)
      }

      onTextEntered(action) {
        this._onTextEntered = action
        return this
      }
    }

    class Task extends View {
      _prefixDot = new ColoredDot()
      _text = new Text()
      _data = undefined

      constructor() {
        super()
        this
          .setDisplay(Displays.grid)
          .setAlignItems(Aligns.center)
          .setGridColumn('1rem 1fr 1rem', '.5rem')
          .addView(this._prefixDot)
          .addView(this._text)
      }

      saveData() {
        save_task_data(this._data)
        return this
      }

      setState(strTaskState) {
        this._data.state = strTaskState
        if (false === this._data.is_activated) {
          return
        }
        this._data.timeCost += (Date.now() - this._data.startTime)
        this._data.startTime = 0
        this._data.is_activated = false
        return this
      }

      get timeCost() {
        const increment = this._data.is_activated ? (Date.now() - this._data.startTime) : 0
        return (this._data.timeCost + increment)
      }

      enableDrag(isEnable = true) {
        this.draggable = true === isEnable
      }

      setData(taskData) {
        this._data = taskData
        this._text.setContent(this._data.desc)
        return this
      }

      setPrefixColor(strValue) {
        this._prefixDot.setBGColor(strValue)
        return this
      }

      setDotAnimation(strValue) {
        this._prefixDot.setAnimation(strValue)
        return this
      }
    }

    class Container extends View {
      constructor() {
        super()
        this
          .setDisplay(Displays.block)
          .setBGColor(Colors.white)
          .setPadding('1rem')
          .setShadow(`0 2px 6px 0 ${Colors.shadow_lighter}`)
      }
    }

    class IconButton extends View {
      constructor() {
        super()
        this
          .setDisplay(Displays.block)
          .setBGRepeat(Repeats.no_repeat)
          .setBGSize('1rem auto')
          .setBGPosition('0 0')
          .setWidth('1rem')
          .setHeight('1rem')

        this.onmouseenter = () => this.setBGPosition('0 -1rem')
        this.onmouseleave = () => this.setBGPosition('0 0')
      }
    }

    class ColoredDot extends View {
      constructor() {
        super()
        this
          .setWidth('1rem')
          .setHeight('1rem')
          .setDisplay(Displays.block)
          .setRadius('.5rem')
          .setMargin('0 5px 0 0')
      }
    }

    customElements.define('text-view', Text)
    customElements.define('colored-dot', ColoredDot)
    customElements.define('icon-button', IconButton)
    customElements.define('container-view', Container)
    customElements.define('section-view', Section)
    customElements.define('section-title', SectionTitle)
    customElements.define('simple-input', Input)
    customElements.define('page-footer', Footer)
    customElements.define('counter-view', Counter)
    customElements.define('counter-button', CounterButton)
    customElements.define('base-view', View)
    customElements.define('task-view', Task)

    let
      isMouseDown = false,
      draggingTask = undefined
    window.onmousedown = () => {
      isMouseDown = true
    }
    window.onmouseup = () => {
      isMouseDown = false
    }

    const
      create_task_data = obj => {
        const self = {
          _id: false,
          desc: false,
          state: task_state.in_progress,
          is_activated: false,
          is_cleared: false,
          timeCost: 0,
          startTime: 0,
          sn: 0,
        }
        for (const key in self) {
          obj.hasOwnProperty(key) && (self[key] = obj[key])
        }
        return self
      },
      footer = new Footer(),
      output = new Text()
        .setHeight('1rem')
        .setLineHeight(1),
      wipSection = new Section()
        .setTitle('进行中')
        .enableClear(false)
        .beforeAddTask(task => task
          .setPrefixColor(Colors.yellow)
          .enableDrag(true))
        .afterAddTask(() => footer.wipCount = wipSection.taskCount)
        .treatFirst(task => task.setDotAnimation('active_color 1s infinite'))
        .onDragStart(task => draggingTask = task)
        .onDrop(targetElement => {
          console.log(targetElement, '<<<<<<<')
        })
        .onDragEnd(() => draggingTask = undefined),
      input = new Input()
        .onTextEntered(text => wipSection
          .addTask(new Task()
            .setData(create_task_data({desc: text}))
            .saveData())),
      completeSection = new Section()
        .setTitle('已完成')
        .enableClear()
        .beforeAddTask(task => task
          .setPrefixColor(Colors.green)
          .enableDrag(false))
        .afterAddTask(() => footer.completeCount = completeSection.taskCount)
        .onDrop(_ => {
          draggingTask && completeSection.addTask(draggingTask)
        }),
      pendingSection = new Section()
        .setTitle('已挂起')
        .enableClear()
        .beforeAddTask(task => task
          .setPrefixColor(Colors.gray)
          .enableDrag(false))
        .afterAddTask(() => footer.pendingCount = pendingSection.taskCount),
      container = new Container()
        .addView(input)
        .addView(output)
        .addView(wipSection)
        .addView(pendingSection)
        .addView(completeSection),
      log = msg => output.setContent(msg || ''),
      onDraw = () => requestAnimationFrame(() => {
        if (false === input.isFocused && false === isMouseDown) {
          input.focus()
        }
        onDraw()
      }),
      one_moment = 20,
      one_second = 50 * one_moment,
      one_minute = 60 * one_second,
      one_hour = 60 * one_minute,
      one_day = 24 * one_hour,
      two_digit = num => (num < 10 ? `0${num}` : num),
      time_str = interval => {
        const day = Math.floor(interval / one_day)
        const hour = Math.floor((interval % one_day) / one_hour)
        const minute = Math.floor((interval % one_hour) / one_minute)
        const second = Math.floor((interval % one_minute) / one_second)
        const millisecond = interval % one_second
        const ms = (millisecond < 10 ? `00${millisecond}`
            : (millisecond < 100 ? `0${millisecond}`
                : millisecond
            )
        )
        return `${day}D${two_digit(hour)}:${two_digit(minute)}:${two_digit(second)}.${ms}`
      },
      url_base = 'https://www.gsegment.com/tms',
      msg_login = 'login please',
      post = (url, data) => new Promise((res, rej) => {
        fetch(
          `${url_base}/${url}?session=${localStorage.tm_session}`,
          {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
              'Content-Type': 'application/json',
            },
          },
        ).then(
          resp => resp.json().then(
            result => {
              if (msg_login === result.msg) {
                rej({msg: '请先登录 - 输入框输入 email:your_email'})
              } else {
                res(result)
              }
            },
          ).catch(
            err => rej({err, msg: 'receive json failed'}),
          ),
        ).catch(
          err => rej({err, msg: 'fetch failed'}),
        )
      }),
      login = (email, password) => new Promise((res, rej) => {
        post('user', {email, password}).then(
          ({success, session}) => {
            if (success) {
              localStorage.tm_session = session
              res(success)
            } else {
              rej({msg: '登录信息有误'})
            }
          },
        ).catch(err => rej(err))
      }),
      list_task = () => post('task/list'),
      save_task_data = task => post('task', task).then(({success, _id}) => {
        if (success) {
          task._id = _id
        } else {
          log('任务保存失败，请咨询服务器管理员')
        }
      }).catch(error => {
        log('任务保存失败', error)
      }),
      trait_login = 'email:',
      credentials = {}
    /////// Globals initialized. ///////

    console.log(
      '%c>>>>%c Log indicate%c developing.',
      'color: #353535; font-weight: 700;',
      'color: deepskyblue;',
      'color: darkgreen;',
    )
    body
      .append(container)
      .append(footer)
    onDraw()

    list_task().then(result => {
      const {
        success,
        tasks,
      } = result
      if (false === success) {
        log('取数据失败 : 请咨询服务器管理员')
        return
      }
      tasks.sort(({sn: a}, {sn: b}) => {
        a = a || 0
        b = b || 0
        return a - b
      })
      // Init the tasks.
      for (const task of tasks) {
        const taskData = create_task_data(task)
        if (task_state.in_progress === task.state) {
          wipSection.addTask(new Task()
            .setData(taskData))
        } else if (task_state.completed === task.state) {
          completeSection.addTask(new Task()
            .setData(taskData))
        } else {
          pendingSection.addTask(new Task()
            .setData(taskData))
        }
      }
    }).catch(res => {
      console.log(res, '<<<<<<< Error')
      log(`取数据失败 : ${res.msg}`)
    })
  })</script>
  <title>日常任务管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="css/task_manager.png"/>
  <style media="screen">
    @keyframes active_color {
      from {
        background-color: #ddcc00;
      }
      30% {
        background-color: #00ff00;
      }
      70% {
        background-color: #dd0000;
      }
      to {
        background-color: #ddcc00;
      }
    }
  </style>
  <style media="screen">
    html, body {
      padding: 0;
      margin: 0;
      font-family: Microsoft YaHei, monospace;
      user-select: none;
      /*pointer-events: none;*/
    }

    body {
      width: 640px;
      margin: 0 auto;
      background: #eeeeee;
      color: #333333;
    }
  </style>
</head>
<body></body>
</html>
